TOPLEVEL=matrix_mult_wrapper
TESTNAME?=default
SRC_VERILOG=../../src/verilog
SYN_FOLDER=../../syn/results
SRC_FOLDER=$(SRC_VERILOG)
SIM=1
SDF=1
RAND_SEED?=42

#Build up a list of verilog define statements to be used by vcs

VERILOG_DEFINES:= 
ifeq ($(SIM), 1)
		VERILOG_DEFINES := $(VERILOG_DEFINES)+SIM=1
endif
ifeq ($(SDF), 1)
		VERILOG_DEFINES := $(VERILOG_DEFINES)+SDF=1
endif




.DEFAULT_GOAL := vcs

# Move all the verilog files from the source directory over to this simulation directory. Being disciplined about file naming
# allows you to automate a lot of these menial and occassionally error inducing tasks.
link_src:
	find $(SRC_FOLDER) -name '*syn.include' -exec ln -s -f {} ';'
	find $(SRC_FOLDER) -name 'matrix_mult_pkg.sv' -exec ln -s -f {} ';'
	find $(SRC_FOLDER) -name 'mem_emulator.sv' -exec ln -s -f {} ';'
	find $(SRC_FOLDER) -name 'tb_*syn.sv' -exec ln -s -f {} ';'
	find $(SRC_FOLDER) -name '*tasks*.sv' -exec ln -s -f {} ';'
	find $(SRC_FOLDER) -name '*.cfg' -exec ln -s -f {} ';'
	find $(SYN_FOLDER) -name '*.v' -exec ln -s -f {} ';'
	find $(SYN_FOLDER) -name '*.sdf' -exec ln -s -f {} ';'
	ln -s $(SYN_FOLDER) syn_results


vcs:$(TOPLEVEL)_syn.include
	mkdir -p golden_log
	touch golden_log/$(TESTNAME).log
	vcs -f $(TOPLEVEL)_syn.include +v2k -R +lint=all -sverilog -full64 \
		-timescale=1ns/10ps -debug_acc+pp+dmptf -debug_region+cell+encrypt \
		-debug_access -l $(TOPLEVEL).log +define+$(VERILOG_DEFINES) +testname=$(TESTNAME) \
		+ntb_random_seed=$(RAND_SEED) \
		-lca -kdb
		# simv 

vrd:
	verdi -dbdir ./simv.daidir/ &

urg:
	urg -dir simv.vdb -format text -report cover_report

wipe:
	rm -rf *.include
	rm -rf syn_results
	rm -rf alib-52
	rm -rf $(TOPLEVEL)
	rm -rf simv.daidir
	rm -rf DVEfiles
	rm -rf *_log
	rm -rf *.log
	rm -rf *.vpd
	rm -rf ucli.key
	rm -rf default.svf
	rm -rf simv
	rm -rf *.sv *.v *.svh
	rm -rf csrc
	rm -rf fsm.sdf
	rm -rf *.fsdb
	rm -rf verdi*
	rm -rf novas*
	rm -rf *.cfg

clean:
	rm -rf DVEfiles
	rm -rf *.log
	rm -rf *.vpd
	rm -rf ucli.key
	rm -rf alib-52
	rm -rf $(TOPLEVEL)
	rm -rf simv.daidir
	rm -rf csrc
	rm -rf simv
	rm -rf *.fsdb
	rm -rf verdi*
	rm -rf novas*

